var app=angular.module("mrImage",[]);app.directive("mrImage",function(){return{restrict:"A",scope:{src:"=mrSrc",maxWidth:"=?mrMaxWidth",aspectRatio:"=?mrAspectRatio",scale:"=?mrScale",drawer:"=?mrDrawer",selector:"=?mrSelector"},template:'<div mr-image-selector mr-model="selector" mr-aspect-ratio="aspectRatio" ng-style="{ \'height\': scaleValuePx(height, scale), \'width\': scaleValuePx(width, scale) }"></div><div mr-image-drawer mr-model="drawer" ng-style="{ \'height\': scaleValuePx(height, scale), \'width\': scaleValuePx(width, scale) }"></div><img ng-src="{{src}}" width="{{scaleValue(width, scale)}}" height="{{scaleValue(height, scale)}}">',link:function(a,b){function c(c){a.image=new Image,a.image.onload=function(){a.$apply(function(){a.height=a.height||a.image.height,a.width=a.width||a.image.width,a.scale=angular.isUndefined(a.scale)&&angular.isDefined(a.maxWidth)?a.maxWidth>=a.width?1:a.maxWidth/a.width:a.scale||1,b.css("width",a.scaleValue(a.width,a.scale)+"px"),b.css("height",a.scaleValue(a.height,a.scale)+"px")})},a.image.src=c}b.addClass("mr-image"),c(a.src),a.scaleValue=function(a,b){return Math.floor(a*b)},a.scaleValuePx=function(a,b){return Math.floor(a*b)+"px"}}}}),app.directive("mrImageDrawer",function(){return{restrict:"A",scope:{rects:"=mrModel"},template:"<div ng-repeat=\"rect in rects\" style=\"position: absolute;cursor: pointer;\"ng-style=\"{   top: rect.y1 + 'px',   left: rect.x1 + 'px',   width: (rect.x2 - rect.x1) + 'px',   height: (rect.y2 - rect.y1) + 'px',   border: (rect.stroke || 3) + 'px solid ' + (rect.color || '#F00'),  'background-color': increaseBrightness(rect.color || '#F00', '0.3') }\" ng-mouseenter=\"rectStyle = { 'background-color': increaseBrightness(rect.color || '#F00', '0.1') }\" ng-mouseout=\"rectStyle =   { 'background-color': increaseBrightness(rect.color || '#F00', '0.3' ) }\" ></div>",link:function(a){a.increaseBrightness=function(a,b){a=a.replace(/^\s*#|\s*$/g,""),3==a.length&&(a=a.replace(/(.)/g,"$1$1"));var c=parseInt(a.substr(0,2),16),d=parseInt(a.substr(2,2),16),e=parseInt(a.substr(4,2),16);return"rgba("+c+","+d+","+e+","+b+")"}}}}),app.directive("mrImageSelector",["$timeout",function(a){function b(a){var b,c={top:0,left:0},d=a&&a[0].ownerDocument;return b=d.documentElement,void 0!==typeof a[0].getBoundingClientRect&&(c=a[0].getBoundingClientRect()),{top:c.top+(window.pageYOffset||b.scrollTop)-(b.clientTop||0),left:c.left+(window.pageXOffset||b.scrollLeft)-(b.clientLeft||0)}}return{restrict:"A",scope:{selector:"=?mrModel",src:"=?mrSrc",aspectRatio:"=?mrAspectRatio"},link:function(c,d){function e(a,b,c){N.css("display","block"),O.css("right",b-a.left+"px"),R.css("left",b-a.right+"px"),P.css("left",a.left+"px"),P.css("right",a.right+"px"),P.css("bottom",c-a.top+"px"),Q.css("left",a.left+"px"),Q.css("right",a.right+"px"),Q.css("top",c-a.bottom+"px")}function f(){I[0].documentElement.className=I[0].documentElement.className.replace(" mr-user-select","")}function g(){I[0].documentElement.className+=" mr-user-select"}function h(){I.bind("mousemove",k),I.bind("mouseup",l)}function i(){I.unbind("mousemove",k),I.unbind("mouseup",l)}function j(a){g();var c=b(d);S=a.pageX-c.left,T=a.pageY-c.top,U=!0,h()}function k(a){U=!1;var e=b(d),f=a.pageX-e.left,g=a.pageY-e.top;c.$apply(function(){m(S,T,f,g)})}function l(){f(),U&&c.$apply(A),i()}function m(a,b,c,e){var f=d.css("height").replace("px",""),g=d.css("width").replace("px","");c=0>c?0:c,c=c>g?g:c,e=0>e?0:e,e=e>f?f:e;var h={top:e>b?b:e,bottom:e>b?f-e:f-b,left:c>a?a:c,right:c>a?g-c:g-a};x(h,g,f)}function n(){I.bind("mousemove",q),I.bind("mouseup",r)}function o(){I.unbind("mousemove",q),I.unbind("mouseup",r)}function p(a){a.stopPropagation(),g(),Y=angular.element(a.target).attr("class").replace("mr-drag-handle","").replace("mr-drag-line","").trim(),V=a.pageX,W=a.pageY,X={top:parseInt(K.css("top")),bottom:parseInt(K.css("bottom")),left:parseInt(K.css("left")),right:parseInt(K.css("right"))},n()}function q(a){var b=d.css("height").replace("px",""),e=d.css("width").replace("px",""),f=a.pageX-V,g=a.pageY-W,h={top:X.top,bottom:X.bottom,left:X.left,right:X.right};"n"==Y[0]?h.top+=g:"s"==Y[0]&&(h.bottom-=g),"w"==Y[0]||"w"==Y[1]?h.left+=f:("e"==Y[0]||"e"==Y[1])&&(h.right-=f);var i;(h.top>=b-h.bottom||h.bottom>=b-h.top)&&(i=h.top,h.top=b-h.bottom,h.bottom=b-i),(h.left>=e-h.right||h.right>=e-h.left)&&(i=h.left,h.left=e-h.right,h.right=e-i),h.top=h.top<0?0:h.top,h.bottom=h.bottom<0?0:h.bottom,h.left=h.left<0?0:h.left,h.right=h.right<0?0:h.right,H&&("n"==Y&&(h.left=e-(h.right+(b-h.top-h.bottom)*H)),"s"==Y&&(h.right=e-(h.left+(b-h.top-h.bottom)*H)),("w"==Y||"nw"==Y||"ne"==Y)&&(h.top=b-(h.bottom+(e-h.left-h.right)/H),h.top<0&&(h.top=0,"w"==Y[0]||"w"==Y[1]?h.left=e-(h.right+(b-h.top-h.bottom)*H):h.right=e-(h.left+(b-h.top-h.bottom)*H))),("e"==Y||"se"==Y||"sw"==Y)&&(h.bottom=b-(h.top+(e-h.left-h.right)/H),h.bottom<0&&(h.bottom=0,"e"==Y[0]||"e"==Y[1]?h.right=e-(h.left+(b-h.top-h.bottom)*H):h.left=e-(h.right+(b-h.top-h.bottom)*H)))),c.$apply(function(){x(h,e,b)})}function r(){f(),o()}function s(){I.bind("mousemove",v),I.bind("mouseup",w)}function t(){I.unbind("mousemove",v),I.unbind("mouseup",w)}function u(a){a.stopPropagation(),g(),V=a.pageX,W=a.pageY,X={top:parseInt(K.css("top")),bottom:parseInt(K.css("bottom")),left:parseInt(K.css("left")),right:parseInt(K.css("right"))},s()}function v(a){var b=d.css("height").replace("px",""),e=d.css("width").replace("px",""),f=a.pageX-V,g=a.pageY-W,h={top:X.top+g,bottom:X.bottom-g,left:X.left+f,right:X.right-f};h.top<0&&(h.bottom=h.bottom+h.top,h.top=0),h.bottom<0&&(h.top=h.bottom+h.top,h.bottom=0),h.left<0&&(h.right=h.right+h.left,h.left=0),h.right<0&&(h.left=h.left+h.right,h.right=0),c.$apply(function(){x(h,e,b)})}function w(){f(),t()}function x(a,b,d){a&&(H&&(S>a.left?a.left=b-(a.right+(d-a.top-a.bottom)*H):a.right=b-(a.left+(d-a.top-a.bottom)*H),a.top<0&&(a.top=0,a.left=b-(a.right+(d-a.top-a.bottom)*H)),a.bottom<0&&(a.bottom=0,a.right=b-(a.left+(d-a.top-a.bottom)*H)),a.left<0&&(a.left=0,a.top=d-(a.bottom+(b-a.left-a.right)/H)),a.right<0&&(a.right=0,a.bottom=d-(a.top+(b-a.left-a.right)/H))),e(a,b,d),K.css("display","block"),K.css({top:a.top+"px",bottom:a.bottom+"px",left:a.left+"px",right:a.right+"px"}),$(),G.x1=a.left,G.y1=a.top,G.x2=b-a.right,G.y2=d-a.bottom,$=c.$watch("selector",D,!0))}function y(){Z||(d.bind("mousedown",j),L.bind("mousedown",p),M.bind("mousedown",p),K.bind("mousedown",u),Z=!0)}function z(){Z&&(d.unbind("mousedown",j),L.unbind("mousedown",p),M.unbind("mousedown",p),K.unbind("mousedown",u),Z=!1)}function A(){G.x1=G.x2=G.y1=G.y2=void 0,K.css("display","none"),N.css("display","none")}function B(){return angular.isUndefined(G.x1)&&angular.isUndefined(G.x2)&&angular.isUndefined(G.y1)&&angular.isUndefined(G.y2)}function C(){return isFinite(G.x1)&&isFinite(G.x2)&&isFinite(G.y1)&&isFinite(G.y2)}function D(a,b){return E(a.enabled),angular.equals(a,b)||a.enabled!=b.enabled||B()?void 0:C()?void m(a.x1,a.y1,a.x2,a.y2):void console.error("[ERROR]: Selector position value (x1, x2, y1, y2) is not a valid number.")}function E(a){G.enabled="boolean"!=typeof a?!0:a,G.enabled&&C()?(y(),d.css("z-index",300),K.css("display","block"),N.css("display","block")):G.enabled?(y(),d.css("z-index",300),A()):(z(),d.css("z-index",100),K.css("display","none"),N.css("display","none"))}function F(){var a=document.createElement("canvas"),b=a.getContext("2d"),d=1/c.$parent.scale,e=(G.x2-G.x1)*d,f=(G.y2-G.y1)*d;return a.width=e,a.height=f,b.drawImage(c.$parent.image,G.x1*d,G.y1*d,e,f,0,0,e,f),a.toDataURL("image/png")}c.selector=c.selector||{};var G=c.selector,H=c.aspectRatio;c.$watch("aspectRatio",function(a){H=a});var I=angular.element(document),J=a(function(){a.cancel(J),G.width&&G.height&&x({top:G.x1,bottom:G.x2,left:G.y1,right:G.y2},G.width,G.height,void 0)}),K=angular.element('<div class="mr-box"><div class="mr-line top"></div><div class="mr-line bottom"></div><div class="mr-line left"></div><div class="mr-line right"></div></div>'),L=angular.element('<div class="mr-drag-line n"></div><div class="mr-drag-line s"></div><div class="mr-drag-line w"></div><div class="mr-drag-line e"></div>'),M=angular.element('<div class="mr-drag-handle nw"></div><div class="mr-drag-handle n"></div><div class="mr-drag-handle ne"></div><div class="mr-drag-handle w"></div><div class="mr-drag-handle e"></div><div class="mr-drag-handle sw"></div><div class="mr-drag-handle s"></div><div class="mr-drag-handle se"></div>');K.append(L).append(M),d.append(K);var N=angular.element('<div class="mr-shadow">'),O=angular.element('<div class="mr-shadow left">'),P=angular.element('<div class="mr-shadow center top">'),Q=angular.element('<div class="mr-shadow center bottom">'),R=angular.element('<div class="mr-shadow right">');N.append(O).append(P).append(Q).append(R),d.append(N);var S,T,U=!1;d.bind("mousedown",j);var V,W,X,Y;L.bind("mousedown",p),M.bind("mousedown",p),K.bind("mousedown",u);var Z=!0;G.clear=A,G.enabled="boolean"!=typeof G.enabled?!0:G.enabled;var $=c.$watch("selector",D,!0);G.crop=F}}}]);